@using SimplifikasiFID.Models;
@model EditFormDTO
@{
    ViewBag.Title = "Edit Form";
    ViewBag.ActiveMenu = "Edit Form";
    ViewBag.ActiveMenuCaption = "Usulan Investasi " + Model.T_FID.Jenisfid;
    ViewBag.Icon = "<i class=\"ace-icon fa fa-folder\"></i>";
    ViewBag.SideMenu = "Yes";
}

@{
    SimplyFIDEntities dbs = new SimplyFIDEntities();
    var fungsi = dbs.M_Fungsi.Where(x => x.FungsiID == Model.T_FID.Fungsipengusul).FirstOrDefault();
    var listFungsi = dbs.M_Fungsi.ToList();
    var category = Model.T_FID.Jenisfid;
}
<style>
    .tg {
        border-collapse: collapse;
        border-spacing: 0;
    }

        .tg td {
            border-color: black;
            border-style: solid;
            border-width: 1px;
            font-family: Arial, sans-serif;
            font-size: 14px;
            overflow: hidden;
            padding: 10px 5px;
            word-break: normal;
        }

        .tg th {
            border-color: black;
            border-style: solid;
            border-width: 1px;
            font-family: Arial, sans-serif;
            font-size: 14px;
            font-weight: normal;
            overflow: hidden;
            padding: 10px 5px;
            word-break: normal;
        }

        .tg .tg-0lax {
            text-align: left;
            vertical-align: top
        }

    tr {
        height: 40px;
    }

    .td-none {
        border: 1px solid #ccc;
        padding: 8px;
    }

    .biru {
        background-color: #ccedff;
    }

    .ace-file-input .ace-file-container.selected + .remove {
        display: none;
    }

    .preview-container {
        margin-top: 20px;
    }

        .preview-container img {
            max-width: 100%;
            max-height: 500px;
            margin-right: 10px;
            margin-bottom: 10px;
            width: 100%;
        }

    .remove-button {
        display: none;
        cursor: pointer;
        color: red;
    }

    @@media (min-width: 992px) {
        .col-md-2 {
            width: 16.666%;
        }

        .col-sm-3 {
            width: 25%;
        }

        .col-md-4 {
            width: 33.333%;
        }

        .col-sm-6 {
            width: 50%;
        }

        .col-sm-7 {
            width: 58.333%;
        }

        .col-md-9 {
            width: 75%;
        }

        .col-sm-10 {
            width: 83.333%;
        }

        .col-md-12 {
            width: 100%;
        }
    }

    li ::marker {
        content: "";
    }

    li.row {
        display: flex;
    }

    .col-sm-1 {
        display: flex;
        align-items: center;
        justify-content: center;
    }

    li.row {
        display: flex;
    }
</style>

<div>
    <div style="margin-top:20px; margin-bottom:20px;">
        <ul class="nav nav-tabs" id="tabs">
            <li id="tab1" class="active">
                <a data-toggle="tab" href="#tabInfo" aria-expanded="true" style="border-left:none;">
                    <i class="fa fa-desktop"></i> Information
                </a>
            </li>
            <li id="tab2">
                <a data-toggle="tab" href="#docPS" aria-expanded="true" style="border-left:none;">
                    <i class="fa fa-file"></i> Doc. PS
                </a>
            </li>
            @{
                if (category != "BD")
                {
                    <li id="tab3">
                        <a data-toggle="tab" href="#docCBA" aria-expanded="true" style="border-left:none;">
                            <i class="fa fa-file"></i> Doc. CBA
                        </a>
                    </li>
                }
            }
        </ul>
        <div class="tab-content" style="min-height:300px;border-bottom:none;border-left:none;border-right:none;padding:0px;">

            <div id="tabInfo" role="dialog" class="tab-pane fade in active">
                <form class="form-horizontal">
                    <div class="mb-2">
                        <h4 style="margin-left:10px;">
                            <i class="fa fa-desktop"></i>
                            Information
                        </h4>
                    </div>
                    <div class="box-body">
                        <br>
                        <div class="form-group" id="idFID">
                            <label for="inputName" class="col-sm-2 control-label">Nomor FID :</label>
                            <div class="col-sm-8">
                                <input class="form-control" id="noFID" readonly style="background-color:whitesmoke;" value="@Model.T_FID.NoFID">
                            </div>
                        </div>

                        <div id="idJudul" class="form-group">
                            <label for="inputName" class="col-sm-2 control-label">Tahun Anggaran :</label>
                            <div class="col-sm-4">
                                <input class="form-control" id="thn_usul" placeholder="Tahun Anggaran" type="text" readonly value="@Model.T_FID.TahunAnggaran" />
                                <script>
                                    $(document).ready(function () {
                                        $("#thn_usul").datepicker({
                                            format: "yyyy",
                                            viewMode: "years",
                                            minViewMode: "years",
                                            autoclose: true
                                        });
                                    })
                                </script>
                            </div>
                        </div>

                        <div id="idJudul" class="form-group">
                            <label for="inputName" class="col-sm-2 control-label">Judul Usulan :</label>
                            <div class="col-sm-8">
                                <input class="form-control" id="judul_usul" placeholder="Judul Usulan" type="text" value="@Model.T_FID.Judulfid">
                            </div>
                        </div>

                        <div id="idABI" class="form-group">
                            <label for="inputName" class="col-sm-2 control-label">Nilai Pengajuan ABI :</label>
                            <div class="col-sm-8">
                                <input class="form-control" id="nilai_abi" placeholder="Nilai ABI Dalam Angka" type="text" onkeypress="return onlyNumberKey(event)" oninput="setCurrency('nilai_abi')" value="@Model.T_FID.NilaiABI">
                                <script>
                                    function setCurrency(id) {
                                        if (document.getElementById(id).value != "") {
                                            document.getElementById(id).value = parseFloat(document.getElementById(id).value.replace(/\,/g, ""))
                                                .toString()
                                                .replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                                        }
                                    }
                                </script>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="inputName" class="col-sm-2 control-label">Fungsi Pengusul :</label>
                            <div class="col-sm-4">
                                <select class="form-control select2" id="fungsi_usul">
                                    @{
                                        if (fungsi != null)
                                        {
                                            <option value="@fungsi.FungsiID" selected>@fungsi.FungsiName</option>
                                        }
                                    }
                                    <option value="">-- Select Fungsi Pengusul --</option>
                                    @foreach (var list in listFungsi)
                                    {
                                        <option value="@list.FungsiID">@list.FungsiName</option>
                                    }
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="inputName" class="col-sm-2 control-label">Jenis Usulan :</label>
                            <div class="col-sm-2">
                                <input class="form-control" id="jenis_usul" placeholder="Judul Usulan" type="text" value="@Model.T_FID.Jenisfid" readonly>

                            </div>
                        </div>
                    </div>

                    <div style="margin-top:20px;">
                        <h4 style="margin-left:10px;">
                            <i class="fa fa-at"></i>
                            Email
                        </h4>
                        <div class="bx d-block body">
                            <div class="form-group" id="cls_email">
                                <label for="inputName" class="col-sm-2 control-label">Name :</label>
                                <div class="col-sm-8">
                                    <input class="form-control" id="name_txt" placeholder="@Model.T_FID.CreatedBy" type="text" readonly style="background-color:whitesmoke;" autocomplete="off">
                                </div>
                            </div>

                            <div id="idEmail" class="form-group">
                                <label for="inputName" class="col-sm-2 control-label">Email :</label>
                                <div class="col-sm-8">
                                    <input class="form-control" id="email_txt" placeholder="email@email.com" value="" type="text" readonly>
                                </div>
                            </div>

                            <div id="idJabatan" class="form-group">
                                <label for="inputName" class="col-sm-2 control-label">Jabatan :</label>
                                <div class="col-sm-8">
                                    <input class="form-control" id="jabatan_txt" placeholder="User" type="text" readonly style="background-color:whitesmoke;" autocomplete="off">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div style="margin-top:20px;">
                        <h4 style="margin-left:10px;">
                            <i class="fa fa-file"></i>
                            File Attachment
                        </h4>
                        <div class="bx d-block body">
                            <div class="form-group" id="cls_email">
                                <label for="inputName" class="col-sm-2 control-label">Others :</label>
                                <div class="col-sm-8">
                                    <input class="form-control" id="file-other" type="file">
                                </div>
                                <div class="col-sm-2">
                                    <span class="fa fa-trash remove-button" id="remove-fl" onclick="removeFiles()"> Remove</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <div id="docPS" role="dialog" class="tab-pane fade" style="padding:0px;padding-top:10px">
                <form class="row" id="frmPS">
                    @{
                        var formPS = Model.M_UploadFiles.Where(x => x.NoFID == Model.T_FID.NoFID && x.Category == "PS").OrderByDescending(x => x.UploadDate).FirstOrDefault();
                        @Html.Raw(formPS.HtmlTag);
                    }
                </form>
            </div>

            @{
                if (category != "BD")

                {
                    <div id="docCBA" role="dialog" class="tab-pane fade" style="padding:0px;padding-top:10px">
                        <form class="row" id="frmCBA">
                            @{
                                var formCBA = Model.M_UploadFiles.Where(x => x.NoFID == Model.T_FID.NoFID && x.Category == "CBA").OrderByDescending(x => x.UploadDate).FirstOrDefault();
                                @Html.Raw(formCBA.HtmlTag);
                            }
                        </form>
                    </div>
                }
            }
        </div>
    </div>

    <div class="row" style="margin-top:20px; margin-bottom:20px; margin-right:20px; float:right;">
        @*<button id="ok" class="btn btn-success" onclick="RemoveButton()">Set all</button>*@
        <button id="ok" class="btn btn-success" onclick="saveUsulan('NEW-EDIT')">Save</button>
        <button id="cancel" class="btn btn-danger" onclick="returnHomeEdit()">Cancel</button>
    </div>
</div>

<script>
    //let idReason = { value: 1 };
    //let idTujuan = { value: 1 };
    //let idWork = { value: 1 };
    //let idNote = { value: 1 };
    //let idDeliver = { value: 1 };
    //let idInvest = { value: 1 };
    //let idDrawdown = { value: 1 };
    //let idSummary = { value: 1 };
    //let idAsumsi = { value: 1 };
    //let idRisiko = { value: 1 };

    //$('#ps_file').ace_file_input();
    //$('#fs_file').ace_file_input();
    //$('#rr_file').ace_file_input();
    //$('#others_file').ace_file_input();
    //$('#cba_file').ace_file_input();
    $('#file-other').ace_file_input();

    showButton();

    function generateJSON2() {
        let datahtml = document.getElementById("frmDocs").innerHTML;

        alert(datahtml);
    }

    $('#file-other').on('change', function () {
        $('.remove-button2').css('display', 'inline');
    });

    function removeFiles() {
        $('#file-other').ace_file_input('reset_input');
        $('.remove-button2').css('display', 'none');
    }

    function saveUsulan(flag) {

        w2confirm('Apakah Anda Yakin Akan Menyimpan Usulan ini? <br>' +
            'Periksa Kembali Dokumen PS (Project Summary) <br>' +
            'Periksa Kembali Dokumen CBA (Cost Benefit Analisys)')
            .yes(() => { saveEditUsulan(flag) })
            .no(() => { return })

    }

    function saveEditUsulan(Flag_update) {

        if (checkText("thn_usul", "Tahun Anggaran Tidak Boleh Kosong !", "tabInfo")) return;
        if (checkText("judul_usul", "Judul Usulan Tidak Boleh Kososng !", "tabInfo")) return;
        if (checkText("nilai_abi", "Nilai ABI Tidak Boleh Kosong !", "tabInfo")) return;
        if (checkText("fungsi_usul", "Fungsi Pengusul Tidak Boleh Kosong !", "tabInfo")) return;

        /*CHECK DOCUMENT PS*/
        if (checkTDEdit("tdpsdept1", "Input Jabatan Penyiap Dokumen PS !", "docPS")) return;
        if (checkTDEdit("tdpsdept2", "Input Jabatan Peneliti Dokumen PS !", "docPS")) return;
        if (checkTDEdit("tdpsnm1", "Input Nama Penyiap Dokumen PS !", "docPS")) return;
        if (checkTDEdit("tdpsnm2", "Input Nama Peneliti Dokumen PS !", "docPS")) return;

        /*CHECK DOCUMENT CBA*/
        if (checkTDEdit("tdpsdept1", "Input Jabatan Penyiap Dokumen PS !", "docCBA")) return;

        RemoveButton();

        var Nominal = $("#nilai_abi").val();
        Nominal = Nominal.replace(/,/g, '');

        let dataPS = document.getElementById("frmPS").innerHTML;
        let categorys = '@category';
        let dataCBA = '';
        if (categorys != "BD") {
            dataCBA = document.getElementById("frmCBA").innerHTML;
        }

        var dataUsulan = new FormData();
        dataUsulan.append('NoFID', $('#noFID').val());
        dataUsulan.append('JudulFID', $('#judul_usul').val());
        dataUsulan.append('ThnAng', $('#thn_usul').val());
        dataUsulan.append('NilaiABI', Nominal);
        dataUsulan.append('FungsiPengusul', $('#fungsi_usul').val());
        dataUsulan.append('JenisFID', $('#jenis_usul').val());
        dataUsulan.append('UserName', '@User.Identity.Name.ToString()');
        dataUsulan.append('Email', $('#email_txt').val());
        dataUsulan.append('Jabatan', 'User');
        dataUsulan.append('Flag_update', Flag_update);
        dataUsulan.append('filePS', dataPS);
        if (categorys != "BD") {
            dataUsulan.append('fileCBA', dataCBA);
        }

        var fileOTH = $("#file-other").get(0);
        var filesOTH = fileOTH.files;
        for (var i = 0; i < filesOTH.length; i++) {
            dataUsulan.append(filesOTH[i].name, filesOTH[i]);
        }
        debugger
        render_wait();

        var Simpan = $.ajax({
           /* url: URL_PTPR + '/FID/SaveFID',*/
            url: URL_PTPR + '/OnlineForm/SaveFID',
            type: 'POST',
            data: dataUsulan,
            dataType: "json",
            cache: false,
            async: false,
            contentType: false,
            processData: false,
        });

        if (Simpan.responseJSON["Result"] != "Error") {
            w2alert('Simpan Usulan success !');
            formDefaultEdit();
            clear_wait();

            window.location.replace(URL_PTPR + "/" + '/FID/vFID?category=bd');
        }
        else {

            alert('Add new FID failed, please try again !  ' + Simpan.responseJSON["Msg"]);

            clear_wait();
        }
    }

    function addDynamicForm(data, idValue) {

        let htmltag = addhtmlform(idValue.value);

        $('#' + data).append(htmltag);

        idValue.value += 1;
    };

    function removeDynamicForm(val, btnId, page) {

        $('#' + val).off('click', '#' + btnId).on('click', '#' + btnId, function () {
            $('#' + page + ' > .container:last').remove();
            if ($("#" + btnId).length == 0) $("#" + page).addClass('hide');
        });
    };

    function addhtmlform(idform) {

        var strhtml = `
                            <div class="container dynfrm" style="margin-bottom:10px;">
                                <table>
                                    <tr style="height:40px;">
                                        <td style="font-size:12px; width:30px; border:none;">
                                            ` + idform + `
                                        </td>
                                        <td style="font-size:14px; border-color:#eadddd;" colspan="2" contenteditable="true">
                                        </td>
                                    </tr>
                                </table>
                            </div>


                    `;
        return strhtml;
    }

    function addImages(filename, imgFrame, btnRemove) {

        $('#' + filename).on('change', function () {
            var file = this.files[0];
            if (file) {
                var reader = new FileReader();
                reader.onload = function (event) {
                    $('#' + imgFrame).attr('src', event.target.result);
                    /*$('.remove-button').css('display', 'inline');*/
                    $('#' + btnRemove).css('display', 'inline');

                    var base64String = event.target.result.split(',')[1];
                    console.log("Ini Base64string nya = " + base64String);
                };
                reader.readAsDataURL(file);
            }
        });

    }

    function removeImages(btnDel, imgFrame, filename) {

        $('#' + imgFrame).attr('src', '');
        $('#' + filename).ace_file_input('reset_input');
        $('#' + btnDel).css('display', 'none');

    }

    function RemoveButton() {
        var table = document.getElementById('tblPS');
        var sections = table.querySelectorAll('section');
        var buttons = table.getElementsByTagName('button');
        var fileInputs = table.querySelectorAll('input[type="file"]');
        var containers = table.querySelectorAll('.dynfrm td');

        buttons = Array.prototype.slice.call(buttons);
        buttons.forEach(function (button) {
            /*button.parentNode.removeChild(button);*/
            button.style.display = 'none';
        });

        fileInputs.forEach(function (fileInput) {
            /*fileInput.parentNode.removeChild(fileInput);*/
            fileInput.style.display = 'none';
        });

        sections.forEach(function (section) {
            /* section.parentNode.removeChild(section);*/
            section.style.display = 'none';
        });

        containers.forEach(function (td) {
            td.style.borderColor = 'transparent';
        });
    }

    function showButton() {
        var table = document.getElementById('tblPS');
        var sections = table.querySelectorAll('section');
        var buttons = table.getElementsByTagName('button');
        var fileInputs = table.querySelectorAll('input[type="file"]');
        var containers = table.querySelectorAll('.dynfrm td');

        buttons = Array.prototype.slice.call(buttons);
        buttons.forEach(function (button) {
            button.style.display = 'block';
        });

        fileInputs.forEach(function (fileInput) {
            fileInput.style.display = 'block';
        });

        sections.forEach(function (section) {
            section.style.display = 'block';
        });

        containers.forEach(function (td) {
            td.style.borderColor = '#eadddd';
        });
    }

    function formDefaultEdit() {
        $('#thn_usul').val("");
        $('#judul_usul').val("");
        $('#nilai_abi').val("");
        $('#fungsi_usul').val("").trigger('change');

        $('#others_file').ace_file_input('reset_input');

        $('#tabs a[href="#info"]').tab('show');
    }


    function checkText(chkid, msg, tabs) {

        if ($('#' + chkid).val() == "") {
            alrt = '<p>' + msg + '</p>';

            $('#alert_msg').html(alrt);
            $('#modal_alert').modal("show");


            $('#tabs a[href="#"' + tabs + ']').tab('show');

            return true;
        }

        return false;
    }

    function checkTDEdit(tdid, msg, tabs) {

        var td = document.getElementById(tdid);

        // Checking if the td element is empty
        var innert = td.innerHTML.trim();
        var string = "<p>Input Text Here</p>";

        if (innert == string) {
            alrt = '<p>' + msg + '</p>';

            $('#alert_msg').html(alrt);
            $('#modal_alert').modal("show");

            $('#tabs a[href="#"' + tabs + ']').tab('show');

            return true;
        }

        return false;
    }

    function formDefaultEdit() {
        $('#thn_usul').val("");
        $('#judul_usul').val("");
        $('#nilai_abi').val("");
        $('#fungsi_usul').val("").trigger('change');

        $('#others_file').ace_file_input('reset_input');

        $('#tabs a[href="#info"]').tab('show');
    }

    function returnHomeEdit() {
        formDefaultEdit();

        var category = '@category';
        if (category == "BD") {
            category = "bd";
        }
        else {
            category = "NonBD";
        }

        window.location.replace(URL_PTPR + "/" + '/FID/vFID?category=' + category);
    }

    function returnHomeEdit() {
        formDefaultEdit();

        var category = '@category';
        if (category == "BD") {
            category = "bd";
        }
        else {
            category = "NonBD";
        }

        window.location.replace(URL_PTPR + "/" + '/FID/vFID?category=' + category);
    }
</script>